---
title: "PA4"
author: "Bernardo Lopez, Victor Zahn, Gregory Morita, Jonathan Garcia"
format: html
editor: visual
embed-resources: true
code-tools: true
code-fold: true
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r}
library(tidyverse)
library(knitr)
library(kableExtra)
library(gt)
library(broom)
library(gtsummary)
library(ggplot2)
library(gganimate)
library(gapminder)
library(gifski)

```

## Introduction

Two datasets:

Extreme poverty rate (\$2.15/day, Gapminder data) long series 1800 to 2100

```{r}
poverty_unclean <- read.csv("./Data/gm_epov_rate.csv")

```

Life expectancy (The number of years a newborn infant would live if the current mortality rates at different ages were to stay the same throughout its life.)

```{r}

expectancy_unclean <- read.csv("./Data/lex.csv")

```

## Data Cleaning

Cleaning the data requires getting rid of country/year pairs with no data in either the poverty rate or life expectancy datasets. This leads to 794 country/year pairs being removed out of 57,792 from the poverty dataset.

```{r}
#| output: false
poverty_unclean |> 
  pivot_longer(cols = "X1800":"X2100",
               names_to = "year",
               values_to = "poverty_rate") |>
  str()

poverty_unclean |> 
  pivot_longer(cols = "X1800":"X2100",
               names_to = "year",
               values_to = "poverty_rate") |>
  map_int(~ sum(is.na(.x))) |>
  enframe(name = "var", value = "missing")

```

The life expectancy dataset ends up with 1,500/58,996 missing country/year pairs with the added condition of having a life expectancy greater than 0 in each data point.

```{r}
#| output: false
expectancy_unclean |>
  pivot_longer(cols = "X1800":"X2100",
               names_to = "year",
               values_to = "life_expectancy") |>
  str()

  expectancy_unclean |>
  pivot_longer(cols = "X1800":"X2100",
               names_to = "year",
               values_to = "life_expectancy") |>
  map_int(~ sum(is.na(.x))) |>
  enframe(name = "var", value = "missing")
```

The rest of the data cleaning adapts the sets to be more workable.

```{r}
poverty <- poverty_unclean |>
  pivot_longer(cols = "X1800":"X2100",
               names_to = "year",
               values_to = "poverty_rate") |>
  filter(!is.na(poverty_rate)) |> # Gets rid of rows with no data
  mutate(year = as.numeric(str_extract(year, pattern = "[:digit:]{4}")), # Extract years
         poverty_rate = poverty_rate/100) # Convert rates to range 0-1

expectancy <- expectancy_unclean |>
  pivot_longer(cols = "X1800":"X2100",
               names_to = "year",
               values_to = "life_expectancy") |>
  filter(!is.na(life_expectancy) & life_expectancy > 0) |> # Get rid of rows with no data (and 0 seems extreme)
  mutate(year = as.numeric(str_extract(year, pattern = "[:digit:]{4}"))) # Extract years

```

Data Joining between the two datasets on country/year pairs with both poverty and life expectancy data.

```{r}
combined <- poverty |>
  full_join(expectancy, join_by(country == country, year == year)) |>
  drop_na()

```

**Hypothesis**

Global modernization and advances in healthcare have contributed to increases in life expectancy in the modern era. These benefits are often unevenly distributed and tend to be concentrated among populations with higher socioeconomic status(Liu et al., 2024). In this study, we will analyze historical poverty rates and life expectancy data to examine if extreme poverty rates have a linear negative relationship with life expectancy rates.

## Modeling the Relationship between extreme poverty rate and life expectancy at birth

# Data Visualizations

To explore the relationship between poverty rate and life expectancy, we start with a scatterplot of the average values for each country across all years. Each point represents a country, with notable outliers labeled. This plot highlights a general trend where countries with higher average poverty rates tend to have lower average life expectancy.The animated plot shows us how this relationship changes over time. We see that across time as poverty rate decreases, life expectency trends towards increasing.

```{r}
if (!exists("summarized")) {
  summarized <- combined |>
    group_by(country) |>
    summarise(
      avg_poverty_rate = mean(poverty_rate, na.rm = TRUE),
      avg_life_expectancy = mean(life_expectancy, na.rm = TRUE)
    )
}
top_bottom <- summarized |>
  arrange(avg_life_expectancy) |>
  slice(c(1:5, (n() - 4):n()))

ggplot(summarized, aes(x = avg_poverty_rate, y = avg_life_expectancy)) +
  geom_point(color = "steelblue", alpha = 0.6, size = 2.5) +
  geom_text(data = top_bottom, aes(label = country), hjust = 1.1, size = 3) +
  labs(
    title = "Country-Level Averages: Life Expectancy vs. Poverty Rate",
    subtitle = "Top and bottom 5 countries by life expectancy labeled",
    x = "Average Poverty Rate (Proportion)",
    y = "Average Life Expectancy (Years)"
  ) +
  theme_minimal()


```



```{r, eval=interactive()}
animated_plot <- ggplot(combined, aes(x = poverty_rate, y = life_expectancy)) +
  geom_point(aes(color = country), alpha = 0.6, show.legend = FALSE) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(
    title = "Year: {frame_time}",
    subtitle = "Tracking poverty vs. life expectancy over time",
    x = "Poverty Rate (Proportion)",
    y = "Life Expectancy (Years)"
  ) +
  transition_time(year) +
  ease_aes('linear') +
  theme_minimal()

animate(animated_plot, renderer = gifski_renderer("poverty_vs_lifeexp.gif"),
        width = 800, height = 500, fps = 10, duration = 10)
```

![](poverty_vs_lifeexp.gif)

# Linear Regression

Fit a linear regression model using the average poverty rate and life expectancy for each country across all years in the dataset (1800-2100). Each point is a single country in the scatterplot.

```{r}

summarized <- combined |>
  group_by(country) |>
  summarise(
    avg_poverty_rate = mean(poverty_rate, na.rm = TRUE),
    avg_life_expectancy = mean(life_expectancy, na.rm = TRUE)) 

summarized |>
  ggplot(aes(x = avg_poverty_rate, y = avg_life_expectancy)) +
  geom_point() +
  geom_smooth(method = "lm")

```

```{r}
summarized_lm <- lm(data = summarized, avg_life_expectancy ~ avg_poverty_rate)

summary(summarized_lm)$coefficients[,4]
summary(summarized_lm)

summarized_lm |>
  tbl_regression(intercept = T) |>
    kable(caption = "Coefficient 
        values returned by the fitted 
        linear regression model", 
        col.names = c("Characteristic", 
                      "Estimated Value", 
                      "95% Confidence Interval", 
                      "P Value")) |>
  kable_styling(full_width = F,
                html_font = "Cambria", 
                bootstrap_options = "striped", 
                position = "center")
  
```

**Interpretation of Returned Coefficient Values** The table above shows both the estimated y-intercept and the slope for the average poverty rate line modeled in the scatter plot above. The estimated intercept is the average estimated life expectancy of a person at a 0% poverty rate. The estimated value for the average poverty rate characteristic is the average expected change of life expectancy for every 10% increased poverty rate a person experiences.

Alongside these values, both the P-value and 95% confidence intervals are reported. The reported P-values being so incredibly low means that the results and relationships shown by the linear model are *very* statistically relevant, meaning that it is reflective of the population and the results are unlikely to be caused by sampling error. Likewise, the 95% confidence interval reported represents that 95% of samples' average values for the given characteristic would lie within the given interval.

# Model Fit

```{r}

# variances
response_variance <- var(summarized$avg_life_expectancy, na.rm = TRUE)  # A
fitted_variance <- var(fitted(summarized_lm))                            # B
residual_variance <- var(residuals(summarized_lm))
r_squared_manual <- fitted_variance / response_variance 

#table

tibble(
  `Measure` = c(
    "Variance in response ",
    "Variance in fitted values",
    "Variance in residuals",
    "RÂ²"
  ),
  `Value` = c(
    response_variance,
    fitted_variance,
    residual_variance,
    r_squared_manual
  )
) |>
  gt() |>
  fmt_number(columns = "Value", decimals = 4) |>
  tab_header(
    title = "Model Variance Summary"
  ) |>
  cols_label(
    Measure = "Descriptive Statistic",
    Value = "Value"
  )
```

**Interpretation of Model Variability**

The model accounts for 61.88% of variability in average life expectancy for each country across all years in the dataset (1800-2100). This suggest that poverty rate is a strong indicator for life expectancy. The model seems to capture a large amount of variance but other variables or interactions may improve model accuracy. The absence of a p-value means we cannot determine whether the relationship between average life expectancy and poverty rate is statistically significant.
